<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frankie — AI Mood Companion · Mood Detector</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0c0b0f;
      --bg-panel: #14121a;
      --bg-card: #1c1924;
      --border: #2d2938;
      --border-soft: #22202a;
      --companion: #b8a9e8;
      --companion-dim: #9b8bcf;
      --calm: #7dd3b0;
      --calm-dim: #5fb892;
      --mood-warm: #e8b89a;
      --mood-cool: #8ab4d4;
      --text: #e8e4ef;
      --text-dim: #8a8599;
      --glow: rgba(184, 169, 232, 0.15);
      --radius: 10px;
      --radius-sm: 6px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    .app { max-width: 920px; margin: 0 auto; padding: 1.25rem 1rem; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem 0 1.25rem;
      border-bottom: 1px solid var(--border-soft);
      margin-bottom: 1.25rem;
    }
    .logo {
      font-weight: 700;
      font-size: 1.6rem;
      color: var(--companion);
      letter-spacing: -0.02em;
    }
    .tagline { font-size: 0.78rem; color: var(--text-dim); margin-top: 0.15rem; }
    .header-right { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .wallet-addr { font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; color: var(--calm); max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .contract-in { width: 200px; padding: 0.45rem 0.6rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-sm); }
    .btn { font-family: 'DM Sans', sans-serif; font-weight: 500; padding: 0.45rem 0.9rem; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.88rem; }
    .btn:hover { border-color: var(--companion-dim); color: var(--companion); }
    .btn.primary { background: var(--companion-dim); border-color: var(--companion); color: var(--bg); }
    .btn.primary:hover { box-shadow: 0 0 14px var(--glow); }
    .btn.calm { border-color: var(--calm-dim); color: var(--calm); }
    .btn.small { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

    .hero {
      text-align: center;
      padding: 1.5rem 1rem;
      background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius);
      margin-bottom: 1.25rem;
    }
    .hero h1 { font-size: 1.35rem; font-weight: 600; color: var(--text); margin-bottom: 0.4rem; }
    .hero p { color: var(--text-dim); font-size: 0.9rem; }

    .stats-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; }
    .stat-card { flex: 1; min-width: 140px; padding: 0.85rem; background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius-sm); }
    .stat-card .label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.25rem; }
    .stat-card .value { font-family: 'IBM Plex Mono', monospace; font-size: 1rem; color: var(--companion); }
    .stat-card .value.calm { color: var(--calm); }

    .tabs { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 1rem; }
    .tab { padding: 0.45rem 0.9rem; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.85rem; }
    .tab:hover { color: var(--text); }
    .tab.active { border-color: var(--companion-dim); color: var(--companion); background: var(--glow); }

    .panel { display: none; }
    .panel.visible { display: block; }

    .card { background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius); padding: 1.1rem; margin-bottom: 1rem; }
    .card h3 { font-size: 0.95rem; margin-bottom: 0.6rem; color: var(--companion-dim); font-weight: 600; }
    .card h4 { font-size: 0.85rem; margin: 0.85rem 0 0.4rem; color: var(--text-dim); font-weight: 500; }
    label { display: block; font-size: 0.78rem; color: var(--text-dim); margin-bottom: 0.25rem; }
    .input, select, textarea { width: 100%; padding: 0.5rem 0.65rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.82rem; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-sm); margin-bottom: 0.5rem; }
    .input:focus, select:focus, textarea:focus { outline: none; border-color: var(--companion-dim); }
    textarea { min-height: 70px; resize: vertical; }
    .actions { display: flex; flex-wrap: wrap; gap: 0.45rem; margin-top: 0.65rem; }
    .msg { padding: 0.5rem; border-radius: var(--radius-sm); margin-top: 0.5rem; font-size: 0.82rem; }
    .msg.ok { background: rgba(125, 211, 176, 0.12); border: 1px solid var(--calm); color: var(--calm); }
    .msg.err { background: rgba(232, 184, 154, 0.1); border: 1px solid var(--mood-warm); color: var(--mood-warm); }
    .msg.info { background: var(--glow); border: 1px solid var(--companion-dim); color: var(--companion); }

    .snapshot-list { list-style: none; }
    .snapshot-list li { border: 1px solid var(--border-soft); border-radius: var(--radius-sm); padding: 0.7rem; margin-bottom: 0.45rem; font-size: 0.82rem; }
    .snapshot-list li:hover { background: var(--bg-panel); }
    .snapshot-list .id { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: var(--text-dim); word-break: break-all; }
    .snapshot-list .meta { margin-top: 0.4rem; display: flex; flex-wrap: wrap; gap: 0.6rem; color: var(--text-dim); font-size: 0.78rem; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; background: var(--border); color: var(--text-dim); }
    .badge.attested { background: rgba(125, 211, 176, 0.2); color: var(--calm); }
    .badge.pending { background: rgba(184, 169, 232, 0.2); color: var(--companion); }

    .bands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.6rem; font-size: 0.82rem; }
    .band-item { padding: 0.6rem; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border-soft); }
    .band-item .band-num { color: var(--companion-dim); font-weight: 600; }
    .band-item .range { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-dim); }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.6rem; font-size: 0.82rem; }
    .config-item { padding: 0.5rem; background: var(--bg); border-radius: var(--radius-sm); }
    .config-item .k { color: var(--text-dim); font-size: 0.75rem; }
    .config-item .v { font-family: 'IBM Plex Mono', monospace; word-break: break-all; font-size: 0.78rem; }

    .footer-note { text-align: center; font-size: 0.75rem; color: var(--text-dim); margin-top: 1.5rem; padding-top: 0.85rem; border-top: 1px solid var(--border-soft); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="logo">Frankie</div>
        <p class="tagline">AI Mood Companion · Mood Detector</p>
      </div>
      <div class="header-right">
        <span id="wallet-addr" class="wallet-addr">Not connected</span>
        <input type="text" id="contract-address" class="contract-in" placeholder="Contract 0x..." />
        <button type="button" id="btn-connect" class="btn primary">Connect</button>
      </div>
    </header>

    <section class="hero">
      <h1>Your mood, on-chain.</h1>
      <p>Record mood snapshots, track sentiment bands, and earn calm points. Frankie is your AI mood companion powered by the Mood Detector contract.</p>
    </section>

    <div class="stats-row">
      <div class="stat-card"><div class="label">Snapshots</div><div class="value" id="stat-snapshots">—</div></div>
      <div class="stat-card"><div class="label">My snapshots</div><div class="value calm" id="stat-my">—</div></div>
      <div class="stat-card"><div class="label">Calm balance</div><div class="value calm" id="stat-calm">—</div></div>
      <div class="stat-card"><div class="label">Prompts</div><div class="value" id="stat-prompts">—</div></div>
      <div class="stat-card"><div class="label">Status</div><div class="value" id="stat-paused">—</div></div>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" data-tab="record">Record mood</button>
      <button type="button" class="tab" data-tab="my">My snapshots</button>
      <button type="button" class="tab" data-tab="bands">Bands</button>
      <button type="button" class="tab" data-tab="roles">Roles (Keeper / Oracle)</button>
      <button type="button" class="tab" data-tab="config">Config</button>
    </div>

    <div id="panel-record" class="panel visible">
      <div class="card">
        <h3>Record mood snapshot</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.85rem;">Choose a sentiment band (0–15) and calm score (0–10000). Optional fee sent to treasury. Prompt hash can be zero.</p>
        <label>Sentiment band (0–15)</label>
        <input type="number" id="record-band" class="input" min="0" max="15" value="0" />
        <label>Calm score (0–10000)</label>
        <input type="number" id="record-score" class="input" min="0" max="10000" value="5000" />
        <label>Prompt hash (hex, or leave 0x0)</label>
        <input type="text" id="record-hash" class="input" placeholder="0x0000000000000000000000000000000000000000000000000000000000000000" />
        <label>Value to send (wei, optional fee)</label>
        <input type="text" id="record-value" class="input" placeholder="0" value="0" />
        <div class="actions">
          <button type="button" id="btn-record" class="btn primary">Record snapshot</button>
        </div>
        <div id="record-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Record batch</h3>
        <label>Bands (comma-separated, e.g. 0,1,2)</label>
        <input type="text" id="batch-bands" class="input" placeholder="0,1,2" />
        <label>Scores (comma-separated, e.g. 3000,5000,7000)</label>
        <input type="text" id="batch-scores" class="input" placeholder="3000,5000,7000" />
        <label>Value to send (wei)</label>
        <input type="text" id="batch-value" class="input" placeholder="0" value="0" />
        <button type="button" id="btn-batch" class="btn calm small">Record batch</button>
        <div id="batch-msg" class="msg" style="display:none;"></div>
      </div>
    </div>

    <div id="panel-my" class="panel">
      <div class="card">
        <h3>My mood snapshots</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">Your recorded snapshots. Attested ones are marked.</p>
        <div class="actions"><button type="button" id="btn-refresh-my" class="btn calm small">Refresh</button></div>
        <ul id="my-snapshots-list" class="snapshot-list"></ul>
        <div id="my-snapshots-empty" style="display:none; color: var(--text-dim); font-size: 0.88rem;">No snapshots yet. Record one from the Record mood tab.</div>
      </div>
      <div class="card">
        <h4>Calm balance</h4>
        <p id="my-calm-balance" style="font-family: 'IBM Plex Mono', monospace; color: var(--calm);">—</p>
      </div>
    </div>

    <div id="panel-bands" class="panel">
      <div class="card">
        <h3>Sentiment bands</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">Configured bands (min–max score) and snapshot counts per band.</p>
        <div id="bands-grid" class="bands-grid"></div>
      </div>
    </div>

    <div id="panel-roles" class="panel">
      <div class="card">
        <h3>Attest snapshot (Sentiment Oracle)</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">Oracle can mark a snapshot as attested.</p>
        <label>Snapshot ID</label>
        <input type="text" id="attest-snapshot-id" class="input" placeholder="1" />
        <button type="button" id="btn-attest" class="btn calm small">Attest</button>
        <div id="attest-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Attest batch (Sentiment Oracle)</h3>
        <label>Snapshot IDs (comma-separated)</label>
        <input type="text" id="attest-batch-ids" class="input" placeholder="1,2,3" />
        <button type="button" id="btn-attest-batch" class="btn calm small">Attest batch</button>
        <div id="attest-batch-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Store companion prompt (Companion Keeper)</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">Store a prompt content hash and band hint.</p>
        <label>Content hash (bytes32 hex)</label>
        <input type="text" id="prompt-hash" class="input" placeholder="0x..." />
        <label>Band hint (0–15)</label>
        <input type="number" id="prompt-band" class="input" min="0" max="15" value="0" />
        <button type="button" id="btn-store-prompt" class="btn primary small">Store prompt</button>
        <div id="store-prompt-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Award calm points (Pulse Relay)</h3>
        <label>User address</label>
        <input type="text" id="award-user" class="input" placeholder="0x..." />
        <label>Amount</label>
        <input type="text" id="award-amount" class="input" placeholder="100" value="0" />
        <button type="button" id="btn-award-calm" class="btn calm small">Award calm</button>
        <div id="award-calm-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Withdraw treasury (Companion Keeper)</h3>
        <label>To address</label>
        <input type="text" id="withdraw-to" class="input" placeholder="0x..." />
        <label>Amount (wei)</label>
        <input type="text" id="withdraw-amount" class="input" placeholder="0" value="0" />
        <button type="button" id="btn-withdraw-treasury" class="btn primary small">Withdraw</button>
        <div id="withdraw-treasury-msg" class="msg" style="display:none;"></div>
      </div>
    </div>

    <div id="panel-config" class="panel">
      <div class="card">
        <h3>Contract config</h3>
        <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">Mood Detector immutable addresses and settings.</p>
        <div class="config-grid" id="config-grid"></div>
        <h4>Immutable addresses</h4>
        <div class="config-grid">
          <div class="config-item"><span class="k">Companion Keeper</span><div class="v" id="cfg-keeper">—</div></div>
          <div class="config-item"><span class="k">Mood Vault</span><div class="v" id="cfg-vault">—</div></div>
          <div class="config-item"><span class="k">Sentiment Oracle</span><div class="v" id="cfg-oracle">—</div></div>
          <div class="config-item"><span class="k">Calm Treasury</span><div class="v" id="cfg-treasury">—</div></div>
          <div class="config-item"><span class="k">Pulse Relay</span><div class="v" id="cfg-relay">—</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 1.25rem;">
      <h3>Global stats</h3>
      <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.6rem;">Total snapshots, prompts, treasury, and attestation rate (when contract is set).</p>
      <div class="stats-row" id="global-stats-row">
        <div class="stat-card"><div class="label">Total snapshots</div><div class="value" id="global-snapshots">—</div></div>
        <div class="stat-card"><div class="label">Total prompts</div><div class="value" id="global-prompts">—</div></div>
        <div class="stat-card"><div class="label">Treasury (wei)</div><div class="value calm" id="global-treasury">—</div></div>
        <div class="stat-card"><div class="label">Attested / Total</div><div class="value" id="global-attested">—</div></div>
      </div>
    </div>
    <div class="card" style="margin-top: 1rem;">
      <h3>About Frankie</h3>
      <p style="color: var(--text-dim); font-size: 0.88rem; line-height: 1.55;">Frankie is the web interface for the Mood Detector (MDT) contract. Record mood snapshots with a sentiment band (0–15) and calm score (0–10000). The Sentiment Oracle can attest snapshots; the Companion Keeper configures bands and stores companion prompts; the Pulse Relay awards calm points to users. Treasury receives optional fees on record. All role addresses are set at deployment and are immutable. Safe for EVM mainnets when deployed with verified addresses.</p>
      <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 0.5rem;">Constants: MDT_SCORE_SCALE 10000, MDT_MAX_SENTIMENT_BANDS 16, MDT_MAX_SNAPSHOTS_PER_USER 128, MDT_BATCH_SIZE 32, MDT_BAND_LOCK_BLOCKS 64.</p>
    </div>
    <p class="footer-note">Frankie · Mood Detector (MDT) · AI mood companion · Not financial advice.</p>
  </div>

  <script>
    (function () {
      const MDT_SCORE_SCALE = 10000;
      const ZERO_BYTES32 = '0x0000000000000000000000000000000000000000000000000000000000000000';
      let provider = null;
      let signer = null;
      let userAddress = null;
      let contractAddress = null;

      const contractIn = document.getElementById('contract-address');
      const walletEl = document.getElementById('wallet-addr');
      const statSnapshots = document.getElementById('stat-snapshots');
      const statMy = document.getElementById('stat-my');
      const statCalm = document.getElementById('stat-calm');
      const statPrompts = document.getElementById('stat-prompts');
      const statPaused = document.getElementById('stat-paused');

      function showMsg(id, text, type) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text;
        el.className = 'msg ' + (type || 'info');
        el.style.display = 'block';
      }
      function hideMsg(id) { const el = document.getElementById(id); if (el) el.style.display = 'none'; }

      function getContractAddr() { return (contractIn.value || '').trim() || contractAddress; }

      async function connectWallet() {
        try {
          if (!window.ethereum) { showMsg('record-msg', 'No Ethereum provider.', 'err'); return; }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (accounts.length) {
            userAddress = accounts[0];
            walletEl.textContent = userAddress.slice(0, 6) + '…' + userAddress.slice(-4);
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            if (contractIn.value.trim()) contractAddress = contractIn.value.trim();
            await refreshStats();
          }
        } catch (e) { showMsg('record-msg', e.message || 'Connect failed', 'err'); }
      }

      async function refreshStats() {
        const addr = getContractAddr();
        if (!addr) {
          statSnapshots.textContent = '—';
          statMy.textContent = '—';
          statCalm.textContent = '—';
          statPrompts.textContent = '—';
          statPaused.textContent = '—';
          return;
        }
        try {
          const abi = [
            'function getFrontendConfig() view returns (address keeper_, address vault_, address oracle_, address treasury_, address relay_, uint256 calmFeeWei_, uint256 treasuryBalance_, bool paused_, uint256 snapshotCount_, uint256 promptCount_, uint256 deployBlock_)',
            'function getSnapshotIdsByUser(address) view returns (uint256[])',
            'function userCalmBalance(address) view returns (uint256)'
          ];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const cfg = await c.getFrontendConfig();
          statSnapshots.textContent = cfg.snapshotCount_.toString();
          statPrompts.textContent = cfg.promptCount_.toString();
          statPaused.textContent = cfg.paused_ ? 'Paused' : 'Active';
          if (userAddress) {
            const ids = await c.getSnapshotIdsByUser(userAddress);
            statMy.textContent = Array.isArray(ids) ? ids.length : 0;
            const bal = await c.userCalmBalance(userAddress);
            statCalm.textContent = bal.toString();
          } else {
            statMy.textContent = '—';
            statCalm.textContent = '—';
          }
        } catch (e) {
          statSnapshots.textContent = '—';
          statMy.textContent = '—';
          statCalm.textContent = '—';
          statPrompts.textContent = '—';
          statPaused.textContent = '—';
        }
      }

      function renderMySnapshots(snapshots) {
        const list = document.getElementById('my-snapshots-list');
        const empty = document.getElementById('my-snapshots-empty');
        list.innerHTML = '';
        if (!snapshots || snapshots.length === 0) { empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        snapshots.forEach(function (s) {
          const li = document.createElement('li');
          li.innerHTML = '<span class="id">#' + (s.id || s.snapshotId) + '</span>' +
            '<div class="meta">Band ' + (s.band ?? s.sentimentBand) + ' · Score ' + (s.calmScore ?? s.score) + ' · Block ' + (s.atBlock ?? s.block) + '</div>' +
            '<span class="badge ' + ((s.attested) ? 'attested' : 'pending') + '">' + (s.attested ? 'Attested' : 'Pending') + '</span>';
          list.appendChild(li);
        });
      }

      async function loadMySnapshots() {
        const addr = getContractAddr();
        if (!addr || !userAddress) { renderMySnapshots([]); return; }
        try {
          const abi = [
            'function getSnapshotIdsByUser(address) view returns (uint256[])',
            'function getSnapshotsByIds(uint256[]) view returns (address[] users, uint8[] bands, uint256[] scores, bytes32[] hashes, uint256[] blocks, bool[] attestedFlags)'
          ];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const ids = await c.getSnapshotIdsByUser(userAddress);
          const arr = Array.isArray(ids) ? ids : [];
          if (arr.length === 0) { renderMySnapshots([]); return; }
          const slice = arr.slice(-20);
          const res = await c.getSnapshotsByIds(slice);
          const snapshots = [];
          for (let i = 0; i < slice.length; i++) {
            snapshots.push({
              id: slice[i].toString(),
              snapshotId: slice[i],
              sentimentBand: res.bands[i],
              band: res.bands[i],
              calmScore: res.scores[i].toString(),
              score: res.scores[i].toString(),
              atBlock: res.blocks[i].toString(),
              block: res.blocks[i].toString(),
              attested: res.attestedFlags[i]
            });
          }
          renderMySnapshots(snapshots.reverse());
          document.getElementById('my-calm-balance').textContent = 'Loading…';
          const balAbi = ['function userCalmBalance(address) view returns (uint256)'];
          const balContract = new ethers.Contract(addr, balAbi, provider);
          const bal = await balContract.userCalmBalance(userAddress);
          document.getElementById('my-calm-balance').textContent = bal.toString();
        } catch (e) { renderMySnapshots([]); document.getElementById('my-calm-balance').textContent = '—'; }
      }

      function renderBands(bands) {
        const grid = document.getElementById('bands-grid');
        grid.innerHTML = '';
        if (!bands || bands.length === 0) return;
        bands.forEach(function (b) {
          const div = document.createElement('div');
          div.className = 'band-item';
          div.innerHTML = '<span class="band-num">Band ' + (b.index ?? b.indices) + '</span><br/><span class="range">' + (b.minScore ?? b.minScores) + '–' + (b.maxScore ?? b.maxScores) + '</span><br/><span class="range">Count: ' + (b.count ?? b.counts ?? '—') + '</span>';
          grid.appendChild(div);
        });
      }

      async function loadBands() {
        const addr = getContractAddr();
        if (!addr) { renderBands([]); return; }
        try {
          const abi = ['function getAllBandConfigs() view returns (uint8[] indices, uint256[] minScores, uint256[] maxScores, uint256[] lockedUntilBlocks, bool[] configured)', 'function getBandsSummary() view returns (uint8[] indices, uint256[] counts, uint256[] sumScores)'];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const configs = await c.getAllBandConfigs();
          const summary = await c.getBandsSummary();
          const bands = [];
          for (let i = 0; i < configs.indices.length; i++) {
            if (!configs.configured[i]) continue;
            bands.push({
              index: configs.indices[i],
              indices: configs.indices[i],
              minScore: configs.minScores[i].toString(),
              minScores: configs.minScores[i].toString(),
              maxScore: configs.maxScores[i].toString(),
              maxScores: configs.maxScores[i].toString(),
              count: summary.counts[i] ? summary.counts[i].toString() : '0',
              counts: summary.counts[i] ? summary.counts[i].toString() : '0'
            });
          }
          renderBands(bands);
        } catch (e) { renderBands([]); }
      }

      async function loadConfig() {
        const addr = getContractAddr();
        const keeper = '0xCe1F9a4b7D2e5A8c0B3d6F9a2E5c8B1d4F7a0C3e6';
        const vault = '0xDf2A0b5c8E3d6F9a1B4e7C0d3F6a9B2e5C8d1F4a7';
        const oracle = '0xE0b3C6d9F2a5E8c1B4e7D0a3F6c9B2e5D8f1A4c7';
        const treasury = '0xF1c4D7e0A3b6F9c2E5a8D1f4B7e0C3a6D9f2B5e8';
        const relay = '0xA2d5E8f1B4c7E0a3D6f9B2e5C8d1F4a7E0b3D6f9';
        document.getElementById('cfg-keeper').textContent = keeper;
        document.getElementById('cfg-vault').textContent = vault;
        document.getElementById('cfg-oracle').textContent = oracle;
        document.getElementById('cfg-treasury').textContent = treasury;
        document.getElementById('cfg-relay').textContent = relay;
        const grid = document.getElementById('config-grid');
        grid.innerHTML = '';
        if (addr) {
          try {
            const abi = ['function getFrontendConfig() view returns (address keeper_, address vault_, address oracle_, address treasury_, address relay_, uint256 calmFeeWei_, uint256 treasuryBalance_, bool paused_, uint256 snapshotCount_, uint256 promptCount_, uint256 deployBlock_)'];
            const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
            const cfg = await c.getFrontendConfig();
            const items = [
              { k: 'Calm fee (wei)', v: cfg.calmFeeWei_.toString() },
              { k: 'Treasury balance', v: cfg.treasuryBalance_.toString() },
              { k: 'Deploy block', v: cfg.deployBlock_.toString() },
              { k: 'Snapshot count', v: cfg.snapshotCount_.toString() },
              { k: 'Prompt count', v: cfg.promptCount_.toString() },
              { k: 'Paused', v: cfg.paused_ ? 'Yes' : 'No' }
            ];
            items.forEach(function (it) {
              const div = document.createElement('div');
              div.className = 'config-item';
              div.innerHTML = '<span class="k">' + it.k + '</span><div class="v">' + it.v + '</div>';
              grid.appendChild(div);
            });
          } catch (_) {}
        }
      }

      document.getElementById('btn-connect').addEventListener('click', connectWallet);

      document.querySelectorAll('.tab').forEach(function (tab) {
        tab.addEventListener('click', function () {
          document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active'); });
          document.querySelectorAll('.panel').forEach(function (p) { p.classList.remove('visible'); });
          tab.classList.add('active');
          const panel = document.getElementById('panel-' + tab.getAttribute('data-tab'));
          if (panel) panel.classList.add('visible');
          if (tab.getAttribute('data-tab') === 'my') loadMySnapshots();
          if (tab.getAttribute('data-tab') === 'bands') loadBands();
          if (tab.getAttribute('data-tab') === 'config') { loadConfig(); loadGlobalStats(); }
        });
      });

      async function loadGlobalStats() {
        const addr = getContractAddr();
        const gs = document.getElementById('global-snapshots');
        const gp = document.getElementById('global-prompts');
        const gt = document.getElementById('global-treasury');
        const ga = document.getElementById('global-attested');
        if (!addr) { gs.textContent = '—'; gp.textContent = '—'; gt.textContent = '—'; ga.textContent = '—'; return; }
        try {
          const abi = ['function getGlobalStats() view returns (uint256 totalSnapshotCount, uint256 totalPromptCount, uint256 totalTreasuryWei, uint256 totalCalmScoreSum, uint256 attestedCount)'];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const res = await c.getGlobalStats();
          gs.textContent = res.totalSnapshotCount.toString();
          gp.textContent = res.totalPromptCount.toString();
          gt.textContent = res.totalTreasuryWei.toString();
          ga.textContent = res.attestedCount.toString() + ' / ' + res.totalSnapshotCount.toString();
        } catch (e) { gs.textContent = '—'; gp.textContent = '—'; gt.textContent = '—'; ga.textContent = '—'; }
      }

      document.getElementById('btn-record').addEventListener('click', async function () {
        hideMsg('record-msg');
